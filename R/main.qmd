---
title: "Entrega 1"
format: html
editor: visual
---

# [Análisis de los casos de anemia en niños y madres en el Perú en el año 2022]{.underline}

## Declaramos las librerías necesarias

```{r, message=FALSE}
library(readr)
library(dplyr)
```

## Leemos las bases de datos

```{r, message=FALSE}
REC91_raw <- read_csv("../data/raw_data/REC91.csv")
REC0111_raw <- read_csv("../data/raw_data/REC0111.csv")
RECH5_raw <- read_csv("../data/raw_data/RECH5.csv")
REC44_raw <- read_csv("../data/raw_data/REC44.csv")
RECH23_raw <- read_csv("../data/raw_data/RECH23.csv")
RECH0_raw <- read_csv("../data/raw_data/RECH0.csv")
```

## Resumen de los datos

Realizaremos un resumen de los datos de cada tabla y, además, comenzaremos con nuestro primer criterio de exclusión: seleccionaremos solo las variables pertinentes para nuestro estudio.

### Tabla RECH0 - Características del hogar

```{r}
summary(RECH0_raw)
```

Seleccionamos las variables pertinentes en nuestro análisis, les cambiamos de nombres y, de ser necesario, cambiamos el tipo de dato.

```{r}
RECH0 <- select(RECH0_raw, HHID, HV009, HV015)

RECH0 <- rename(RECH0,
                cuestionario_hogar_id = HHID,
                personas_en_el_hogar = HV009,
                estado_entrevista = HV015)

RECH0$cuestionario_hogar_id <- as.character(RECH0$cuestionario_hogar_id)
RECH0$estado_entrevista <- as.character(RECH0$estado_entrevista)

str(RECH0)
```

### Tabla REC0111 - Datos básicos del MEF

Relación entre identificación del cuestionario individual e identificación del cuestionario del hogar.

```{r}
summary(REC0111_raw)
```

Seleccionamos las variables pertinentes en nuestro análisis, les cambiamos de nombres y, de ser necesario, cambiamos el tipo de dato.

```{r}
REC0111 <- select(REC0111_raw, CASEID, HHID, V024, V102)

REC0111 <- rename(REC0111,
                  cuestionario_individual_id = CASEID,
                  cuestionario_hogar_id = HHID,
                  region = V024,
                  tipo_de_residencia = V102)

REC0111$cuestionario_individual_id <- as.character(REC0111$cuestionario_individual_id)
REC0111$cuestionario_hogar_id <- as.character(REC0111$cuestionario_hogar_id)
REC0111$region <- as.character(REC0111$region)
REC0111$tipo_de_residencia <- as.character(REC0111$tipo_de_residencia)

str(REC0111)
```

### Tabla RECH5 - Peso y talla (anemia)

Características de las mujeres de 12 a 49 años (madres de los infantes descritos en la tabla REC44).

```{r}
summary(RECH5_raw)
```

Seleccionamos las variables pertinentes en nuestro análisis, les cambiamos de nombres y, de ser necesario, cambiamos el tipo de dato.

```{r}
RECH5 <- select(RECH5_raw, HHID, HA1, HA2, HA3, HA13, HA53, HA54, HA55, HA56, HA57, HA67)

RECH5 <- rename(RECH5,
                cuestionario_individual_id = HHID,
                edad = HA1,
                peso = HA2,
                talla = HA3,
                estado_medicion = HA13,
                hemoglobina = HA53,
                is_embarazada = HA54,
                estado_medicion_hemoglobina = HA55,
                homoglobina_ajustada_latitud = HA56,
                anemia = HA57,
                nivel_educativo = HA67)

RECH5$estado_medicion <- as.character(RECH5$estado_medicion)
RECH5$is_embarazada <- as.character(RECH5$is_embarazada)
RECH5$estado_medicion_hemoglobina <- as.character(RECH5$estado_medicion_hemoglobina)
RECH5$anemia <- as.character(RECH5$anemia)
RECH5$nivel_educativo <- as.character(RECH5$nivel_educativo)

str(RECH5)
```

Asignamos la categoría que corresponde a cada número para la variable *anemia*.

```{r}
RECH5$anemia[RECH5$anemia %in% c(1)] <- "grave"
RECH5$anemia[RECH5$anemia %in% c(2)] <- "moderado"
RECH5$anemia[RECH5$anemia %in% c(3)] <- "leve"
RECH5$anemia[RECH5$anemia %in% c(4)] <- "sin_anemia"
```

Cambiamos las unidades de *talla* y *peso*.

```{r}
RECH5 <- mutate(RECH5,
                # Convertimos de centímetros a metros
                talla = talla / 1000,
                # Convertimos de gramos a kilogramos
                peso = peso / 10)
```

### Tabla REC44 - Peso y talla (anemia)

Características de los infantes de 0 a 59 meses (5 años aproximadamente) por mamá.

```{r}
summary(REC44_raw)
```

Seleccionamos las variables pertinentes en nuestro análisis, les cambiamos de nombres y, de ser necesario, cambiamos el tipo de dato.

```{r}
REC44 <- select(REC44_raw, CASEID, HW1, HW2, HW3, HW13, HW53, HW55, HW56, HW57)

REC44 <- rename(REC44,
                cuestionario_individual_id = CASEID,
                edad = HW1,
                peso = HW2,
                talla = HW3,
                estado_medicion = HW13,
                hemoglobina = HW53,
                estado_medicion_hemoglobina = HW55,
                hemoglobina_ajustada_latitud = HW56,
                anemia = HW57)

REC44$estado_medicion <- as.character(REC44$estado_medicion)
REC44$estado_medicion_hemoglobina <- as.character(REC44$estado_medicion_hemoglobina)
REC44$anemia <- as.character(REC44$anemia)

str(REC44)
```

Asignamos la categoría que corresponde a cada número para la variable *anemia*.

```{r}
REC44$anemia[REC44$anemia %in% c(1)] <- "grave"
REC44$anemia[REC44$anemia %in% c(2)] <- "moderado"
REC44$anemia[REC44$anemia %in% c(3)] <- "leve"
REC44$anemia[REC44$anemia %in% c(4)] <- "sin_anemia"
```

Cambiamos las unidades de *talla* y *peso*.

```{r}
REC44 <- mutate(REC44,
                # Agregamos el decimal mencionado en el diccionario.
                talla = talla / 10,
                # Agregamos el decimal mencionado en el diccionario.
                peso = peso / 10)
```

## Limpieza de datos

Vamos a descartar las observaciones que no tengan información, no tengan variabilidad o contengan datos atípicos.

### RECH0

Realizamos un filtro en función de la variable *estado_entrevista*.

```{r}
RECH0 <- filter(RECH0, estado_entrevista == 1)
```

### RECH5

Realizamos un filtro en función de la variable *estado_medicion* y *estado_medicion_hemoglobina.*

```{r}
RECH5 <- filter(RECH5, estado_medicion == 0)
RECH5 <- filter(RECH5, estado_medicion_hemoglobina == 0)
```

### REC44

Realizamos un filtro en función de la variable *estado_medicion* y *estado_medicion_hemoglobina.*

```{r}
REC44 <-filter(REC44, estado_medicion == 0)
REC44 <- filter(REC44, estado_medicion_hemoglobina == 0)
```

## Análisis de datos

### Objetivo 1

Describir los casos de anemia y su severidad en niños y madres en el Perú en el año 2022.

#### Anemia en niños

Promedio de edad, talla, peso y hemoglobina en niños con anemia leve, moderada y grave.

```{r}
niños_anemia_leve <- filter(REC44, anemia == "leve")
niños_anemia_moderada <- filter(REC44, anemia == "moderado")
niños_anemia_grave <- filter(REC44, anemia == "grave")

niños_promedios_anemia_leve <- data.frame(colMeans(niños_anemia_leve[, sapply(niños_anemia_leve, is.numeric)]))
niños_promedios_anemia_moderada <- data.frame(colMeans(niños_anemia_moderada[, sapply(niños_anemia_moderada, is.numeric)]))
niños_promedios_anemia_grave <- data.frame(colMeans(niños_anemia_grave[, sapply(niños_anemia_grave, is.numeric)]))

print(niños_promedios_anemia_leve)
print(niños_promedios_anemia_moderada)
print(niños_promedios_anemia_grave)
```

#### Anemia en madres

Promedio de edad, talla, peso y hemoglobina en madres con anemia leve, moderada y grave.

```{r}
madres_anemia_leve <- filter(RECH5, anemia == "leve")
madres_anemia_moderada <- filter(RECH5, anemia == "moderado")
madres_anemia_grave <- filter(RECH5, anemia == "grave")

madres_promedios_anemia_leve <- data.frame(colMeans(madres_anemia_leve[, sapply(madres_anemia_leve, is.numeric)]))
madres_promedios_anemia_moderada <- data.frame(colMeans(madres_anemia_moderada[, sapply(madres_anemia_moderada, is.numeric)]))
madres_promedios_anemia_grave <- data.frame(colMeans(madres_anemia_grave[, sapply(madres_anemia_grave, is.numeric)]))

print(madres_promedios_anemia_leve)
print(madres_promedios_anemia_moderada)
print(madres_promedios_anemia_grave)
```

### Objetivo 2

Analizamos el índice de anemia en niños en las diversas regiones del Perú en el año 2022.

```{r}
REC44_joined = inner_join(REC44, REC0111, by = "cuestionario_individual_id")
REC44_joined$anemia_numeric <- as.numeric(REC44_joined$anemia %in% c("leve", "moderado", "grave"))

# Calculamos el índice de anemia por región
indice_anemia_por_region <- REC44_joined %>%
  group_by(region) %>%
  summarize(anemia = mean(anemia_numeric) * 100)
  
# Ordenamos el índice de anemia de mayor a menor
indice_anemia_por_region <- indice_anemia_por_region %>%
  arrange(desc(anemia))
  
# Mostramos el resultado
print(indice_anemia_por_region)
```

Analizamos el índice de anemia en madres en las diversas regiones del Perú en el año 2022.

```{r}
RECH5_joined = inner_join(RECH5, 
                          mutate(REC0111,
                                 cuestionario_individual_id = substr(cuestionario_individual_id,
                                                                     1,
                                                                     nchar(cuestionario_individual_id) - 3)),
                          by = "cuestionario_individual_id")

RECH5_joined$anemia_numeric <- as.numeric(RECH5_joined$anemia %in% c("leve", "moderado", "grave"))

# Calculamos el índice de anemia por región
indice_anemia_por_region <- RECH5_joined %>%
  group_by(region) %>%
  summarize(anemia = mean(anemia_numeric) * 100)
  
# Ordenamos el índice de anemia de mayor a menor
indice_anemia_por_region <- indice_anemia_por_region %>%
  arrange(desc(anemia))
  
# Mostramos el resultado
print(indice_anemia_por_region)
```

### Objetivo 3

Describir las características sociales de los grupos vulnerables ---niños y madres--- a la anemia en el Perú en el año 2022.

#### Características del hogar

Para los niños vamos a revisar sus características de como viven en su hogar

```{r}
mean(REC44$edad)
median(REC44$edad)

mean(REC44$peso)
median(REC44$peso)

mean(REC44$talla)
median(REC44$talla)

```

```{r}
mean(RECH5$edad)
median(RECH5$edad)

mean(RECH5$peso)
median(RECH5$peso)

mean(RECH5$talla)
median(RECH5$talla)

names(which.max(table(RECH5$is_embarazada)))

table(RECH5$nivel_educativo)
```

Vemos que en los datos que los describen la mediana y la media aritmética son semejantes, por lo que es válido usar esos 2 o la moda para calcular una tendencia.

Lo representamos graficamente

```{r}
boxplot(RECH5$edad)
```

```{r}
boxplot(RECH5$peso)
```

```{r}
boxplot(RECH5$talla)
```

Vamos a comparar entre anemia y nivel educativo de las madres, a ver si existe alguna relación.

```{r}
table(RECH5$anemia, RECH5$nivel_educativo)
```

#### Relación entre el tipo de residencia y el nivel de anemia de los niños.

```{r}
niños_anemia <- bind_rows(niños_anemia_leve, niños_anemia_moderada, niños_anemia_grave)

niños <- inner_join(REC0111, niños_anemia, by = "cuestionario_individual_id")

tabla_niños_residencia <- table(niños$tipo_de_residencia, niños$anemia)

tabla_niños_residencia 

```

```{r}
library(ggplot2)

df <- as.data.frame(tabla_niños_residencia)

colnames(df) <- c("tipo_de_residencia", "anemia", "frecuencia")

df$tipo_de_residencia <- as.factor(df$tipo_de_residencia)
df$tipo_de_residencia <- recode(df$tipo_de_residencia, 
                                `1` = "Urbano", 
                                `2` = "Rural")
df$anemia <- as.factor(df$anemia)


ggplot(df, aes(x = tipo_de_residencia, y = frecuencia, fill = anemia)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Tipo de Residencia", y = "Frecuencia", fill = "Nivel de Anemia en niños") +
  theme_minimal()

```

```{r}
library(gt)

df <- data.frame(
  tipo_de_residencia = c(1, 2),
  grave = c(14, 13),
  leve = c(3223, 1891),
  moderado = c(1232, 967)
)

df$total <- rowSums(df[,2:4])

df$tipo_de_residencia <- as.factor(df$tipo_de_residencia)
df$tipo_de_residencia <- recode(df$tipo_de_residencia, 
                                `1` = "Urbano", 
                                `2` = "Rural")

gt(df) %>%
  tab_header(
    title = "Tabla de Contingencia",
    subtitle = "Tipo de Residencia vs Nivel de Anemia"
  ) %>%
  cols_label(
    tipo_de_residencia = "Tipo de Residencia",
    grave = "Grave",
    leve = "Leve",
    moderado = "Moderado",
    total = "Total"
  ) %>%
  fmt_number(
    columns = vars(grave, leve, moderado, total),
    decimals = 0
  )

```

Como podemos observar, la proporción entre los distintos tipos de anemia es bastante similar sea el tipo de residencia urbano o rural.
